# OAuth2 Client Credentials Middleware
# Use for service-to-service authentication
#
# Required secrets:
#   - service-auth/client-id
#   - service-auth/client-secret
#
# Usage: Apply to appHttpPipeline for outgoing service calls

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: oauth2-cc
  namespace: default
spec:
  type: middleware.http.oauth2clientcredentials
  version: v1
  metadata:
  # Client Credentials (use secret references)
  - name: clientId
    secretKeyRef:
      name: service-auth
      key: client-id
  - name: clientSecret
    secretKeyRef:
      name: service-auth
      key: client-secret

  # Scopes for service access
  - name: scopes
    value: "api://target-service/.default"

  # Token endpoint
  - name: tokenURL
    value: "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token"

  # Header to attach the access token
  - name: headerName
    value: "authorization"

  # Auth style: 0=auto, 1=POST body, 2=HTTP Basic
  - name: authStyle
    value: "0"

  # Path filter (regex) - only apply to matching paths
  # - name: pathFilter
  #   value: ".*/internal/.*"
