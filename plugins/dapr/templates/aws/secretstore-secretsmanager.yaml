# AWS Secrets Manager Secret Store
# Centralized secrets management with rotation support
#
# Features:
#   - Automatic secret rotation
#   - Fine-grained IAM access control
#   - Cross-account secret sharing
#   - Versioned secrets
#
# Authentication: IAM credentials, EKS IRSA, or environment variables

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: aws-secrets
  namespace: default
spec:
  type: secretstores.aws.secretmanager
  version: v1
  metadata:
  # AWS Region
  - name: region
    value: "us-east-1"

  # Authentication (omit on EKS with IRSA/IAM roles)
  - name: accessKey
    secretKeyRef:
      name: aws-bootstrap
      key: access-key
  - name: secretKey
    secretKeyRef:
      name: aws-bootstrap
      key: secret-key

  # Parse JSON secrets into multiple key-value pairs
  - name: multipleKeyValuesPerSecret
    value: "true"

# Usage in other components:
# - name: password
#   secretKeyRef:
#     name: aws-secrets    # This component name
#     key: database/prod   # Secret name in AWS Secrets Manager

# IAM Policy (minimum permissions):
# {
#   "Version": "2012-10-17",
#   "Statement": [{
#     "Effect": "Allow",
#     "Action": [
#       "secretsmanager:GetSecretValue",
#       "secretsmanager:DescribeSecret"
#     ],
#     "Resource": "arn:aws:secretsmanager:*:*:secret:*"
#   }]
# }

# Create a secret (AWS CLI):
# aws secretsmanager create-secret \
#   --name database/prod \
#   --secret-string '{"username":"admin","password":"secret123"}'

# Retrieve with version:
# GET /v1.0/secrets/aws-secrets/database/prod?metadata.version_id=xxx

---
# AWS SSM Parameter Store (Alternative)
# Lower cost for simple key-value secrets

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: aws-params
  namespace: default
spec:
  type: secretstores.aws.parameterstore
  version: v1
  metadata:
  - name: region
    value: "us-east-1"
  - name: accessKey
    secretKeyRef:
      name: aws-bootstrap
      key: access-key
  - name: secretKey
    secretKeyRef:
      name: aws-bootstrap
      key: secret-key

# SSM Parameter Store is better for:
# - Configuration values
# - Lower cost at scale
# - Hierarchical organization (/app/prod/db/password)
#
# Secrets Manager is better for:
# - Automatic rotation
# - Binary secrets
# - Cross-account sharing
