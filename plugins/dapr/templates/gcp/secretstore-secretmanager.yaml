# GCP Secret Manager Secret Store
# Centralized secrets management with versioning and IAM
#
# Features:
#   - Automatic replication across regions
#   - Secret versioning
#   - Fine-grained IAM access control
#   - Audit logging
#
# Authentication: Workload Identity, Service Account, or ADC

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: gcp-secrets
  namespace: default
spec:
  type: secretstores.gcp.secretmanager
  version: v1
  metadata:
  # Required: GCP Project ID
  - name: project_id
    value: "my-gcp-project"

  # Authentication type
  - name: type
    value: "service_account"

  # Service Account credentials (alternative to Workload Identity)
  - name: private_key_id
    secretKeyRef:
      name: gcp-bootstrap
      key: private-key-id
  - name: private_key
    secretKeyRef:
      name: gcp-bootstrap
      key: private-key
  - name: client_email
    secretKeyRef:
      name: gcp-bootstrap
      key: client-email
  - name: client_id
    secretKeyRef:
      name: gcp-bootstrap
      key: client-id
  - name: auth_uri
    value: "https://accounts.google.com/o/oauth2/auth"
  - name: token_uri
    value: "https://oauth2.googleapis.com/token"
  - name: auth_provider_x509_cert_url
    value: "https://www.googleapis.com/oauth2/v1/certs"
  # - name: client_x509_cert_url
  #   value: "https://www.googleapis.com/robot/v1/metadata/x509/SERVICE_ACCOUNT"

# GKE with Workload Identity (recommended):
# apiVersion: dapr.io/v1alpha1
# kind: Component
# metadata:
#   name: gcp-secrets
# spec:
#   type: secretstores.gcp.secretmanager
#   version: v1
#   metadata:
#   - name: project_id
#     value: "my-gcp-project"
#   - name: type
#     value: "service_account"

# Usage in other components:
# - name: password
#   secretKeyRef:
#     name: gcp-secrets       # This component name
#     key: database-password  # Secret name in GCP Secret Manager

# Retrieve with version:
# GET /v1.0/secrets/gcp-secrets/database-password?metadata.version_id=1

# IAM Roles needed:
# - roles/secretmanager.secretAccessor (read secrets)
# - roles/secretmanager.admin (manage secrets)

# Enable Secret Manager API:
# gcloud services enable secretmanager.googleapis.com

# Create a secret:
# echo -n "my-secret-value" | gcloud secrets create database-password --data-file=-

# Add a new version:
# echo -n "new-secret-value" | gcloud secrets versions add database-password --data-file=-

# Access a secret:
# gcloud secrets versions access latest --secret=database-password
