# Azure Cosmos DB State Store
# Globally distributed, multi-model database for state management
#
# Features:
#   - Strong consistency for actors
#   - Automatic partitioning
#   - Multi-region replication
#   - TTL support

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: statestore
  namespace: default
spec:
  type: state.azure.cosmosdb
  version: v1
  metadata:
  # Required: Cosmos DB account URL
  - name: url
    value: "https://{account-name}.documents.azure.com:443/"

  # Required: Database name
  - name: database
    value: "daprdb"

  # Required: Container name
  - name: collection
    value: "state"

  # Authentication: Managed Identity (Recommended)
  - name: azureClientId
    value: "{managed-identity-client-id}"

  # Alternative: Service Principal
  # - name: azureTenantId
  #   value: "{tenant-id}"
  # - name: azureClientId
  #   value: "{client-id}"
  # - name: azureClientSecret
  #   secretKeyRef:
  #     name: cosmos-secrets
  #     key: client-secret

  # Alternative: Connection String (Not recommended for production)
  # - name: masterKey
  #   secretKeyRef:
  #     name: cosmos-secrets
  #     key: master-key

  # Optional: Enable actor state store
  - name: actorStateStore
    value: "true"

  # Optional: Consistency level (Strong, BoundedStaleness, Session, Eventual)
  - name: consistencyLevel
    value: "Strong"

  # Optional: Partition key (for custom partitioning)
  # - name: partitionKey
  #   value: "/partitionKey"

# Usage with DAPR HTTP API:
# Save state:
# curl -X POST http://localhost:3500/v1.0/state/statestore \
#   -H "Content-Type: application/json" \
#   -d '[{"key": "order-123", "value": {"status": "pending", "total": 99.99}}]'
#
# Get state:
# curl http://localhost:3500/v1.0/state/statestore/order-123
#
# Delete state:
# curl -X DELETE http://localhost:3500/v1.0/state/statestore/order-123

# Python SDK example:
# from dapr.clients import DaprClient
#
# with DaprClient() as client:
#     # Save state
#     client.save_state(
#         store_name="statestore",
#         key="order-123",
#         value=json.dumps({"status": "pending", "total": 99.99})
#     )
#
#     # Get state
#     state = client.get_state(store_name="statestore", key="order-123")
#     order = json.loads(state.data)
#
#     # Delete state
#     client.delete_state(store_name="statestore", key="order-123")
#
#     # Transaction (actors)
#     client.execute_state_transaction(
#         store_name="statestore",
#         operations=[
#             TransactionalStateOperation(key="key1", data=json.dumps(value1)),
#             TransactionalStateOperation(key="key2", data=json.dumps(value2), operationType=TransactionOperationType.delete)
#         ]
#     )

# Local development with Cosmos DB Emulator:
# docker run -p 8081:8081 -p 10251:10251 -p 10252:10252 -p 10253:10253 -p 10254:10254 \
#   -m 3g --cpus=2.0 \
#   -e AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10 \
#   -e AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE=true \
#   mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator
#
# Emulator URL: https://localhost:8081
# Master Key: C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==

# Azure CLI setup:
# az cosmosdb create --name {account-name} --resource-group {rg} --default-consistency-level Strong
# az cosmosdb sql database create --account-name {account-name} --resource-group {rg} --name daprdb
# az cosmosdb sql container create --account-name {account-name} --resource-group {rg} --database-name daprdb --name state --partition-key-path /partitionKey

# Managed Identity setup for Container Apps:
# az identity create --name dapr-identity --resource-group {rg}
# IDENTITY_ID=$(az identity show --name dapr-identity --resource-group {rg} --query principalId -o tsv)
# COSMOS_ID=$(az cosmosdb show --name {account-name} --resource-group {rg} --query id -o tsv)
# az role assignment create --role "Cosmos DB Built-in Data Contributor" --assignee $IDENTITY_ID --scope $COSMOS_ID
