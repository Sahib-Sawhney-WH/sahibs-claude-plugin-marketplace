# DAPR Access Control List (ACL) Template
# Controls which apps can access which components
# Reference: https://docs.dapr.io/operations/configuration/api-allowlist/

apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: {{APP_NAME}}-acl
  namespace: default
spec:
  # ==========================================================================
  # ACCESS CONTROL - Restrict service-to-service communication
  # ==========================================================================
  accessControl:
    # Default action when no rules match
    defaultAction: deny

    # Trust domain for mTLS
    trustDomain: "cluster.local"

    # App-level access policies
    policies:
      # -----------------------------------------------------------------------
      # Order Service - Can call inventory and payment
      # -----------------------------------------------------------------------
      - appId: order-service
        defaultAction: deny
        trustDomain: "cluster.local"
        namespace: default
        operations:
          - name: /products/*
            httpVerb: ["GET"]
            action: allow
          - name: /inventory/*
            httpVerb: ["GET", "POST"]
            action: allow
          - name: /payments/*
            httpVerb: ["POST"]
            action: allow

      # -----------------------------------------------------------------------
      # Inventory Service - Limited external access
      # -----------------------------------------------------------------------
      - appId: inventory-service
        defaultAction: deny
        trustDomain: "cluster.local"
        namespace: default
        operations:
          - name: /products/*
            httpVerb: ["GET"]
            action: allow
          - name: /stock/*
            httpVerb: ["GET", "PUT"]
            action: allow

      # -----------------------------------------------------------------------
      # Payment Service - Highly restricted
      # -----------------------------------------------------------------------
      - appId: payment-service
        defaultAction: deny
        trustDomain: "cluster.local"
        namespace: default
        operations:
          - name: /payments/process
            httpVerb: ["POST"]
            action: allow
          - name: /payments/*/status
            httpVerb: ["GET"]
            action: allow

  # ==========================================================================
  # API ACCESS - Control which APIs are available
  # ==========================================================================
  api:
    allowed:
      # -----------------------------------------------------------------------
      # Enable specific DAPR APIs
      # -----------------------------------------------------------------------
      - name: state
        version: v1.0
        protocol: http

      - name: pubsub
        version: v1.0
        protocol: http

      - name: invoke
        version: v1.0
        protocol: http

      - name: secrets
        version: v1.0
        protocol: http

      - name: bindings
        version: v1.0
        protocol: http

      - name: actors
        version: v1.0
        protocol: http

      - name: workflows
        version: v1.0
        protocol: http

      # Alpha APIs (enable as needed)
      # - name: configuration
      #   version: v1.0-alpha1
      #   protocol: http

      # - name: lock
      #   version: v1.0-alpha1
      #   protocol: http

      # - name: crypto
      #   version: v1.0-alpha1
      #   protocol: http

      # - name: jobs
      #   version: v1.0-alpha1
      #   protocol: http

      # - name: conversation
      #   version: v1.0-alpha1
      #   protocol: http

  # ==========================================================================
  # mTLS CONFIGURATION
  # ==========================================================================
  mtls:
    enabled: true
    workloadCertTTL: "24h"
    allowedClockSkew: "15m"

  # ==========================================================================
  # TRACING CONFIGURATION
  # ==========================================================================
  tracing:
    samplingRate: "1"  # 100% sampling, reduce for production
    zipkin:
      endpointAddress: "http://zipkin.observability.svc.cluster.local:9411/api/v2/spans"

  # ==========================================================================
  # METRICS CONFIGURATION
  # ==========================================================================
  metrics:
    enabled: true
    http:
      increasedCardinality: false
